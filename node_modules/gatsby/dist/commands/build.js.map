{"version":3,"sources":["../../src/commands/build.ts"],"names":["module","exports","build","program","process","env","VERBOSE","verbose","report","setVerbose","profile","warn","name","sitePackageJson","sitePath","directory","lastRun","Date","now","pid","publicDir","path","join","GATSBY_OPEN_TRACING_CONFIG_FILE","openTracingConfigFile","buildActivity","phantomActivity","start","telemetry","trackCli","exitCode","buildSpan","span","setTag","gatsbyNodeGraphQLFunction","workerPool","parentSpan","engineBundlingPromises","push","graphqlRunner","GraphQLRunner","store","collectStats","graphqlTracing","queryIds","pageQueryIds","filter","query","mode","waitForWorkerPoolRestart","Promise","resolve","GATSBY_EXPERIMENTAL_PARALLEL_QUERY_RUNNING","restart","graphql","buildActivityTimer","activityTimer","stats","waitForCompilerClose","result","hasWarnings","rawMessages","toJson","moduleTrace","warnings","err","panic","Stage","BuildJavascript","end","webpackCompilationHash","hash","getState","appDataUtil","exists","dispatch","type","payload","rewriteActivityTimer","write","isTrackingEnabled","bundleSizes","assets","asset","endsWith","map","size","pageDataSizes","pageDataStats","values","addSiteMeasurement","bundleStats","aggregateStats","queryStats","getStats","actions","setProgramStatus","db","saveState","buildSSRBundleActivityProgress","pageRenderer","waitForCompilerCloseBuildHtml","BuildHTML","rendererPath","outputDir","fs","ensureDir","then","copyFile","all","send","action","routesWebpackConfig","reject","compiler","run","close","error","undefined","keepPageRenderer","toRegenerate","toDelete","waitWorkerPoolEnd","pagesCount","length","totalPagesCount","pages","postBuildActivityTimer","e","message","info","uptime","finish","logPages","writeToFile","createdFilesPath","createdFilesContent","deletedFilesPath","deletedFilesContent","writeFile"],"mappings":"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","sourcesContent":["import path from \"path\"\nimport report from \"gatsby-cli/lib/reporter\"\nimport signalExit from \"signal-exit\"\nimport fs from \"fs-extra\"\nimport telemetry from \"gatsby-telemetry\"\nimport { updateSiteMetadata, isTruthy } from \"gatsby-core-utils\"\nimport {\n  buildRenderer,\n  buildHTMLPagesAndDeleteStaleArtifacts,\n  IBuildArgs,\n} from \"./build-html\"\nimport { buildProductionBundle } from \"./build-javascript\"\nimport { bootstrap } from \"../bootstrap\"\nimport apiRunnerNode from \"../utils/api-runner-node\"\nimport { GraphQLRunner } from \"../query/graphql-runner\"\nimport { copyStaticDirs } from \"../utils/get-static-dir\"\nimport { initTracer, stopTracer } from \"../utils/tracer\"\nimport * as db from \"../redux/save-state\"\nimport { store } from \"../redux\"\nimport * as appDataUtil from \"../utils/app-data\"\nimport { flush as flushPendingPageDataWrites } from \"../utils/page-data\"\nimport {\n  structureWebpackErrors,\n  reportWebpackWarnings,\n} from \"../utils/webpack-error-utils\"\nimport {\n  userGetsSevenDayFeedback,\n  userPassesFeedbackRequestHeuristic,\n  showFeedbackRequest,\n  showSevenDayFeedbackRequest,\n} from \"../utils/feedback\"\nimport { actions } from \"../redux/actions\"\nimport { waitUntilAllJobsComplete } from \"../utils/wait-until-jobs-complete\"\nimport { Stage } from \"./types\"\nimport {\n  calculateDirtyQueries,\n  runStaticQueries,\n  runPageQueries,\n  writeOutRequires,\n} from \"../services\"\nimport {\n  markWebpackStatusAsPending,\n  markWebpackStatusAsDone,\n} from \"../utils/webpack-status\"\nimport { showExperimentNotices } from \"../utils/show-experiment-notice\"\nimport {\n  mergeWorkerState,\n  runQueriesInWorkersQueue,\n} from \"../utils/worker/pool\"\nimport webpackConfig from \"../utils/webpack.config.js\"\nimport { webpack } from \"webpack\"\nimport { createGraphqlEngineBundle } from \"../schema/graphql-engine/bundle-webpack\"\nimport { createPageSSRBundle } from \"../utils/page-ssr-module/bundle-webpack\"\nimport { shouldGenerateEngines } from \"../utils/engines-helpers\"\n\nmodule.exports = async function build(program: IBuildArgs): Promise<void> {\n  if (isTruthy(process.env.VERBOSE)) {\n    program.verbose = true\n  }\n  report.setVerbose(program.verbose)\n\n  if (program.profile) {\n    report.warn(\n      `React Profiling is enabled. This can have a performance impact. See https://www.gatsbyjs.org/docs/profiling-site-performance-with-react-profiler/#performance-impact`\n    )\n  }\n\n  await updateSiteMetadata({\n    name: program.sitePackageJson.name,\n    sitePath: program.directory,\n    lastRun: Date.now(),\n    pid: process.pid,\n  })\n\n  markWebpackStatusAsPending()\n\n  const publicDir = path.join(program.directory, `public`)\n  initTracer(\n    process.env.GATSBY_OPEN_TRACING_CONFIG_FILE || program.openTracingConfigFile\n  )\n  const buildActivity = report.phantomActivity(`build`)\n  buildActivity.start()\n\n  telemetry.trackCli(`BUILD_START`)\n  signalExit(exitCode => {\n    telemetry.trackCli(`BUILD_END`, {\n      exitCode: exitCode as number | undefined,\n    })\n  })\n\n  const buildSpan = buildActivity.span\n  buildSpan.setTag(`directory`, program.directory)\n\n  const { gatsbyNodeGraphQLFunction, workerPool } = await bootstrap({\n    program,\n    parentSpan: buildSpan,\n  })\n\n  const engineBundlingPromises: Array<Promise<any>> = []\n\n  if (_CFLAGS_.GATSBY_MAJOR === `4` && shouldGenerateEngines()) {\n    // bundle graphql-engine\n    engineBundlingPromises.push(createGraphqlEngineBundle())\n  }\n\n  const graphqlRunner = new GraphQLRunner(store, {\n    collectStats: true,\n    graphqlTracing: program.graphqlTracing,\n  })\n\n  const { queryIds } = await calculateDirtyQueries({ store })\n\n  // Only run queries with mode SSG\n  if (_CFLAGS_.GATSBY_MAJOR === `4`) {\n    queryIds.pageQueryIds = queryIds.pageQueryIds.filter(\n      query => query.mode === `SSG`\n    )\n  }\n\n  let waitForWorkerPoolRestart = Promise.resolve()\n  if (process.env.GATSBY_EXPERIMENTAL_PARALLEL_QUERY_RUNNING) {\n    await runQueriesInWorkersQueue(workerPool, queryIds)\n    // Jobs still might be running even though query running finished\n    await waitUntilAllJobsComplete()\n    // Restart worker pool before merging state to lower memory pressure while merging state\n    waitForWorkerPoolRestart = workerPool.restart()\n    await mergeWorkerState(workerPool)\n  } else {\n    await runStaticQueries({\n      queryIds,\n      parentSpan: buildSpan,\n      store,\n      graphqlRunner,\n    })\n\n    await runPageQueries({\n      queryIds,\n      graphqlRunner,\n      parentSpan: buildSpan,\n      store,\n    })\n  }\n\n  await writeOutRequires({\n    store,\n    parentSpan: buildSpan,\n  })\n\n  await apiRunnerNode(`onPreBuild`, {\n    graphql: gatsbyNodeGraphQLFunction,\n    parentSpan: buildSpan,\n  })\n\n  // Copy files from the static directory to\n  // an equivalent static directory within public.\n  copyStaticDirs()\n\n  const buildActivityTimer = report.activityTimer(\n    `Building production JavaScript and CSS bundles`,\n    { parentSpan: buildSpan }\n  )\n  buildActivityTimer.start()\n  let stats\n  let waitForCompilerClose\n  try {\n    const result = await buildProductionBundle(program, buildActivityTimer.span)\n    stats = result.stats\n    waitForCompilerClose = result.waitForCompilerClose\n\n    if (stats.hasWarnings()) {\n      const rawMessages = stats.toJson({ moduleTrace: false })\n      reportWebpackWarnings(rawMessages.warnings, report)\n    }\n  } catch (err) {\n    buildActivityTimer.panic(structureWebpackErrors(Stage.BuildJavascript, err))\n  } finally {\n    buildActivityTimer.end()\n  }\n\n  if (_CFLAGS_.GATSBY_MAJOR === `4` && shouldGenerateEngines()) {\n    // client bundle is produced so static query maps should be ready\n    engineBundlingPromises.push(createPageSSRBundle())\n  }\n\n  const webpackCompilationHash = stats.hash\n  if (\n    webpackCompilationHash !== store.getState().webpackCompilationHash ||\n    !appDataUtil.exists(publicDir)\n  ) {\n    store.dispatch({\n      type: `SET_WEBPACK_COMPILATION_HASH`,\n      payload: webpackCompilationHash,\n    })\n\n    const rewriteActivityTimer = report.activityTimer(\n      `Rewriting compilation hashes`,\n      {\n        parentSpan: buildSpan,\n      }\n    )\n    rewriteActivityTimer.start()\n\n    await appDataUtil.write(publicDir, webpackCompilationHash)\n\n    rewriteActivityTimer.end()\n  }\n\n  await flushPendingPageDataWrites(buildSpan)\n  markWebpackStatusAsDone()\n\n  if (telemetry.isTrackingEnabled()) {\n    // transform asset size to kB (from bytes) to fit 64 bit to numbers\n    const bundleSizes = stats\n      .toJson({ assets: true })\n      .assets.filter(asset => asset.name.endsWith(`.js`))\n      .map(asset => asset.size / 1000)\n    const pageDataSizes = [...store.getState().pageDataStats.values()]\n\n    telemetry.addSiteMeasurement(`BUILD_END`, {\n      bundleStats: telemetry.aggregateStats(bundleSizes),\n      pageDataStats: telemetry.aggregateStats(pageDataSizes),\n      queryStats: graphqlRunner.getStats(),\n    })\n  }\n\n  store.dispatch(actions.setProgramStatus(`BOOTSTRAP_QUERY_RUNNING_FINISHED`))\n\n  await db.saveState()\n\n  await waitUntilAllJobsComplete()\n\n  // we need to save it again to make sure our latest state has been saved\n  await db.saveState()\n\n  const buildSSRBundleActivityProgress = report.activityTimer(\n    `Building HTML renderer`,\n    { parentSpan: buildSpan }\n  )\n  buildSSRBundleActivityProgress.start()\n  let pageRenderer = ``\n  let waitForCompilerCloseBuildHtml\n  try {\n    const result = await buildRenderer(\n      program,\n      Stage.BuildHTML,\n      buildSSRBundleActivityProgress.span\n    )\n    pageRenderer = result.rendererPath\n    if (_CFLAGS_.GATSBY_MAJOR === `4` && shouldGenerateEngines()) {\n      // for now copy page-render to `.cache` so page-ssr module can require it as a sibling module\n      const outputDir = path.join(program.directory, `.cache`, `page-ssr`)\n      engineBundlingPromises.push(\n        fs\n          .ensureDir(outputDir)\n          .then(() =>\n            fs.copyFile(\n              result.rendererPath,\n              path.join(outputDir, `render-page.js`)\n            )\n          )\n      )\n    }\n    waitForCompilerCloseBuildHtml = result.waitForCompilerClose\n\n    if (_CFLAGS_.GATSBY_MAJOR === `4` && shouldGenerateEngines()) {\n      Promise.all(engineBundlingPromises).then(() => {\n        if (process.send) {\n          process.send({\n            type: `LOG_ACTION`,\n            action: {\n              type: `ENGINES_READY`,\n            },\n          })\n        }\n      })\n    }\n\n    // TODO Move to page-renderer\n    if (_CFLAGS_.GATSBY_MAJOR === `4`) {\n      const routesWebpackConfig = await webpackConfig(\n        program,\n        program.directory,\n        `build-ssr`,\n        null,\n        { parentSpan: buildSSRBundleActivityProgress.span }\n      )\n\n      await new Promise((resolve, reject) => {\n        const compiler = webpack(routesWebpackConfig)\n        compiler.run(err => {\n          if (err) {\n            return void reject(err)\n          }\n\n          compiler.close(error => {\n            if (error) {\n              return void reject(error)\n            }\n            return void resolve(undefined)\n          })\n\n          return undefined\n        })\n      })\n    }\n  } catch (err) {\n    buildActivityTimer.panic(structureWebpackErrors(Stage.BuildHTML, err))\n  } finally {\n    buildSSRBundleActivityProgress.end()\n  }\n\n  if (_CFLAGS_.GATSBY_MAJOR === `4` && shouldGenerateEngines()) {\n    // well, tbf we should just generate this in `.cache` and avoid deleting it :shrug:\n    program.keepPageRenderer = true\n  }\n\n  await waitForWorkerPoolRestart\n\n  const { toRegenerate, toDelete } =\n    await buildHTMLPagesAndDeleteStaleArtifacts({\n      program,\n      pageRenderer,\n      workerPool,\n      buildSpan,\n    })\n\n  const waitWorkerPoolEnd = Promise.all(workerPool.end())\n\n  telemetry.addSiteMeasurement(`BUILD_END`, {\n    pagesCount: toRegenerate.length, // number of html files that will be written\n    totalPagesCount: store.getState().pages.size, // total number of pages\n  })\n\n  const postBuildActivityTimer = report.activityTimer(`onPostBuild`, {\n    parentSpan: buildSpan,\n  })\n  postBuildActivityTimer.start()\n  await apiRunnerNode(`onPostBuild`, {\n    graphql: gatsbyNodeGraphQLFunction,\n    parentSpan: postBuildActivityTimer.span,\n  })\n  postBuildActivityTimer.end()\n\n  // Wait for any jobs that were started in onPostBuild\n  // This could occur due to queries being run which invoke sharp for instance\n  await waitUntilAllJobsComplete()\n\n  try {\n    await waitWorkerPoolEnd\n  } catch (e) {\n    report.warn(`Error when closing WorkerPool: ${e.message}`)\n  }\n\n  // Make sure we saved the latest state so we have all jobs cached\n  await db.saveState()\n\n  await Promise.all([waitForCompilerClose, waitForCompilerCloseBuildHtml])\n\n  report.info(`Done building in ${process.uptime()} sec`)\n\n  buildSpan.finish()\n  await stopTracer()\n  buildActivity.end()\n\n  if (program.logPages) {\n    if (toRegenerate.length) {\n      report.info(\n        `Built pages:\\n${toRegenerate\n          .map(path => `Updated page: ${path}`)\n          .join(`\\n`)}`\n      )\n    }\n\n    if (toDelete.length) {\n      report.info(\n        `Deleted pages:\\n${toDelete\n          .map(path => `Deleted page: ${path}`)\n          .join(`\\n`)}`\n      )\n    }\n  }\n\n  if (program.writeToFile) {\n    const createdFilesPath = path.resolve(\n      `${program.directory}/.cache`,\n      `newPages.txt`\n    )\n    const createdFilesContent = toRegenerate.length\n      ? `${toRegenerate.join(`\\n`)}\\n`\n      : ``\n\n    const deletedFilesPath = path.resolve(\n      `${program.directory}/.cache`,\n      `deletedPages.txt`\n    )\n    const deletedFilesContent = toDelete.length\n      ? `${toDelete.join(`\\n`)}\\n`\n      : ``\n\n    await fs.writeFile(createdFilesPath, createdFilesContent, `utf8`)\n    report.info(`.cache/newPages.txt created`)\n\n    await fs.writeFile(deletedFilesPath, deletedFilesContent, `utf8`)\n    report.info(`.cache/deletedPages.txt created`)\n  }\n\n  await Promise.all(engineBundlingPromises)\n\n  showExperimentNotices()\n\n  if (await userGetsSevenDayFeedback()) {\n    showSevenDayFeedbackRequest()\n  } else if (await userPassesFeedbackRequestHeuristic()) {\n    showFeedbackRequest()\n  }\n}\n"],"file":"build.js"}