{"version":3,"sources":["../../../src/bootstrap/load-plugins/validate.ts"],"names":["getGatsbyUpgradeVersion","entries","reduce","version","entry","api","semver","gt","getBadExports","plugin","pluginAPIKeys","apis","badExports","concat","_","difference","map","e","exportName","pluginName","name","pluginVersion","getErrorContext","exportType","currentAPIs","latestAPIs","ex","gatsbyUpgradeVersion","errors","fixes","forEach","similarities","stringSimilarity","findBestMatch","isDefaultPlugin","message","push","bestMatch","rating","target","sourceMessage","length","filter","Boolean","join","handleBadExports","hasBadExports","Object","keys","find","toPairs","badItem","context","reporter","error","id","validatePluginsOptions","plugins","rootDir","newPlugins","Promise","all","gatsbyNode","resolvedPlugin","require","resolve","err","pluginOptionsSchema","subPluginPaths","Set","optionsSchema","Joi","extend","joi","base","any","type","args","array","items","alternatives","string","object","options","unknown","custom","value","helpers","modulePath","module","normalizedPath","state","path","key","index","Array","isArray","ancestors","Error","add","console","log","default","isSchema","warn","describe","append","subErrors","subPlugins","size","from","ValidationError","validationWarnings","details","validationErrors","configDir","parentDir","relative","valueString","validateConfigPluginsOptions","config","process","exit","collatePluginAPIs","flattenedPlugins","node","browser","ssr","nodeAPIs","browserAPIs","ssrAPIs","pluginNodeExports","mode","pluginBrowserExports","pluginSSRExports","intersection","handleMultipleReplaceRenderers","rendererPlugins","includes","env","NODE_ENV","ignorable","slice","messages","fp","i","skipSSR","m","warnOnIncompatiblePeerDependency","packageJSON","gatsbyPeerDependency","get","satisfies","gatsbyVersion","includePrerelease"],"mappings":"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","sourcesContent":["import _ from \"lodash\"\nimport path from \"path\"\nimport * as semver from \"semver\"\nimport * as stringSimilarity from \"string-similarity\"\nimport { version as gatsbyVersion } from \"gatsby/package.json\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport { validateOptionsSchema, Joi } from \"gatsby-plugin-utils\"\nimport { IPluginRefObject } from \"gatsby-plugin-utils/dist/types\"\nimport { stripIndent } from \"common-tags\"\nimport { trackCli } from \"gatsby-telemetry\"\nimport { resolveModuleExports } from \"../resolve-module-exports\"\nimport { getLatestAPIs } from \"../../utils/get-latest-apis\"\nimport { GatsbyNode, PackageJson } from \"../../../\"\nimport {\n  IPluginInfo,\n  IFlattenedPlugin,\n  IPluginInfoOptions,\n  ISiteConfig,\n} from \"./types\"\nimport { resolvePlugin } from \"./load\"\n\ninterface IApi {\n  version?: string\n}\n\nexport interface IEntry {\n  exportName: string\n  pluginName: string\n  pluginVersion: string\n  api?: IApi\n}\n\nexport type ExportType = \"node\" | \"browser\" | \"ssr\"\n\ntype IEntryMap = {\n  [exportType in ExportType]: Array<IEntry>\n}\n\nexport type ICurrentAPIs = {\n  [exportType in ExportType]: Array<string>\n}\n\nconst getGatsbyUpgradeVersion = (entries: ReadonlyArray<IEntry>): string =>\n  entries.reduce((version, entry) => {\n    if (entry.api && entry.api.version) {\n      return semver.gt(entry.api.version, version || `0.0.0`)\n        ? entry.api.version\n        : version\n    }\n    return version\n  }, ``)\n\n// Given a plugin object, an array of the API names it exports and an\n// array of valid API names, return an array of invalid API exports.\nfunction getBadExports(\n  plugin: IPluginInfo,\n  pluginAPIKeys: ReadonlyArray<string>,\n  apis: ReadonlyArray<string>\n): Array<IEntry> {\n  let badExports: Array<IEntry> = []\n  // Discover any exports from plugins which are not \"known\"\n  badExports = badExports.concat(\n    _.difference(pluginAPIKeys, apis).map(e => {\n      return {\n        exportName: e,\n        pluginName: plugin.name,\n        pluginVersion: plugin.version,\n      }\n    })\n  )\n  return badExports\n}\n\nfunction getErrorContext(\n  badExports: Array<IEntry>,\n  exportType: ExportType,\n  currentAPIs: ICurrentAPIs,\n  latestAPIs: { [exportType in ExportType]: { [exportName: string]: IApi } }\n): {\n  errors: Array<string>\n  entries: Array<IEntry>\n  exportType: ExportType\n  fixes: Array<string>\n  sourceMessage: string\n} {\n  const entries = badExports.map(ex => {\n    return {\n      ...ex,\n      api: latestAPIs[exportType][ex.exportName],\n    }\n  })\n\n  const gatsbyUpgradeVersion = getGatsbyUpgradeVersion(entries)\n  const errors: Array<string> = []\n  const fixes = gatsbyUpgradeVersion\n    ? [`npm install gatsby@^${gatsbyUpgradeVersion}`]\n    : []\n\n  entries.forEach(entry => {\n    const similarities = stringSimilarity.findBestMatch(\n      entry.exportName,\n      currentAPIs[exportType]\n    )\n    const isDefaultPlugin = entry.pluginName == `default-site-plugin`\n\n    const message = entry.api\n      ? entry.api.version\n        ? `was introduced in gatsby@${entry.api.version}`\n        : `is not available in your version of Gatsby`\n      : `is not a known API`\n\n    if (isDefaultPlugin) {\n      errors.push(\n        `- Your local gatsby-${exportType}.js is using the API \"${entry.exportName}\" which ${message}.`\n      )\n    } else {\n      errors.push(\n        `- The plugin ${entry.pluginName}@${entry.pluginVersion} is using the API \"${entry.exportName}\" which ${message}.`\n      )\n    }\n\n    if (similarities.bestMatch.rating > 0.5) {\n      fixes.push(\n        `Rename \"${entry.exportName}\" -> \"${similarities.bestMatch.target}\"`\n      )\n    }\n  })\n\n  return {\n    errors,\n    entries,\n    exportType,\n    fixes,\n    // note: this is a fallback if gatsby-cli is not updated with structured error\n    sourceMessage: [\n      `Your plugins must export known APIs from their gatsby-node.js.`,\n    ]\n      .concat(errors)\n      .concat(\n        fixes.length > 0\n          ? [`\\n`, `Some of the following may help fix the error(s):`, ...fixes]\n          : []\n      )\n      .filter(Boolean)\n      .join(`\\n`),\n  }\n}\n\nexport async function handleBadExports({\n  currentAPIs,\n  badExports,\n}: {\n  currentAPIs: ICurrentAPIs\n  badExports: { [api in ExportType]: Array<IEntry> }\n}): Promise<void> {\n  const hasBadExports = Object.keys(badExports).find(\n    api => badExports[api].length > 0\n  )\n  if (hasBadExports) {\n    const latestAPIs = await getLatestAPIs()\n    // Output error messages for all bad exports\n    _.toPairs(badExports).forEach(badItem => {\n      const [exportType, entries] = badItem\n      if (entries.length > 0) {\n        const context = getErrorContext(\n          entries,\n          exportType as keyof typeof badExports,\n          currentAPIs,\n          latestAPIs\n        )\n        reporter.error({\n          id: `11329`,\n          context,\n        })\n      }\n    })\n  }\n}\n\nasync function validatePluginsOptions(\n  plugins: Array<IPluginRefObject>,\n  rootDir: string | null\n): Promise<{\n  errors: number\n  plugins: Array<IPluginRefObject>\n}> {\n  let errors = 0\n  const newPlugins = await Promise.all(\n    plugins.map(async plugin => {\n      let gatsbyNode\n      try {\n        const resolvedPlugin = resolvePlugin(plugin, rootDir)\n        gatsbyNode = require(`${resolvedPlugin.resolve}/gatsby-node`)\n      } catch (err) {\n        gatsbyNode = {}\n      }\n\n      if (!gatsbyNode.pluginOptionsSchema) return plugin\n\n      const subPluginPaths = new Set<string>()\n\n      let optionsSchema = (\n        gatsbyNode.pluginOptionsSchema as Exclude<\n          GatsbyNode[\"pluginOptionsSchema\"],\n          undefined\n        >\n      )({\n        Joi: Joi.extend(joi => {\n          return {\n            base: joi.any(),\n            type: `subPlugins`,\n            args: (_, args: any): any => {\n              const entry = args?.entry ?? `index`\n\n              return joi\n                .array()\n                .items(\n                  joi\n                    .alternatives(\n                      joi.string(),\n                      joi.object({\n                        resolve: Joi.string(),\n                        options: Joi.object({}).unknown(true),\n                      })\n                    )\n                    .custom((value, helpers) => {\n                      if (typeof value === `string`) {\n                        value = { resolve: value }\n                      }\n\n                      try {\n                        const resolvedPlugin = resolvePlugin(value, rootDir)\n                        const modulePath = require.resolve(\n                          `${resolvedPlugin.resolve}/${entry}`\n                        )\n                        value.modulePath = modulePath\n                        value.module = require(modulePath)\n\n                        const normalizedPath = helpers.state.path\n                          .map((key, index) => {\n                            // if subplugin is part of an array - swap concrete index key with `[]`\n                            if (\n                              typeof key === `number` &&\n                              Array.isArray(\n                                helpers.state.ancestors[\n                                  helpers.state.path.length - index - 1\n                                ]\n                              )\n                            ) {\n                              if (index !== helpers.state.path.length - 1) {\n                                throw new Error(\n                                  `No support for arrays not at the end of path`\n                                )\n                              }\n                              return `[]`\n                            }\n\n                            return key\n                          })\n                          .join(`.`)\n\n                        subPluginPaths.add(normalizedPath)\n                      } catch (err) {\n                        console.log(err)\n                      }\n\n                      return value\n                    }, `Gatsby specific subplugin validation`)\n                )\n                .default([])\n            },\n          }\n        }),\n      })\n\n      if (!Joi.isSchema(optionsSchema) || optionsSchema.type !== `object`) {\n        // Validate correct usage of pluginOptionsSchema\n        reporter.warn(\n          `Plugin \"${plugin.resolve}\" has an invalid options schema so we cannot verify your configuration for it.`\n        )\n        return plugin\n      }\n\n      try {\n        if (!optionsSchema.describe().keys.plugins) {\n          // All plugins have \"plugins: []\"\" added to their options in load.ts, even if they\n          // do not have subplugins. We add plugins to the schema if it does not exist already\n          // to make sure they pass validation.\n          optionsSchema = optionsSchema.append({\n            plugins: Joi.array().length(0),\n          })\n        }\n\n        plugin.options = await validateOptionsSchema(\n          optionsSchema,\n          (plugin.options as IPluginInfoOptions) || {}\n        )\n\n        if (plugin.options?.plugins) {\n          const { errors: subErrors, plugins: subPlugins } =\n            await validatePluginsOptions(\n              plugin.options.plugins as Array<IPluginRefObject>,\n              rootDir\n            )\n          plugin.options.plugins = subPlugins\n          if (subPlugins.length > 0) {\n            subPluginPaths.add(`plugins.[]`)\n          }\n          errors += subErrors\n        }\n        if (subPluginPaths.size > 0) {\n          plugin.subPluginPaths = Array.from(subPluginPaths)\n        }\n      } catch (error) {\n        if (error instanceof Joi.ValidationError) {\n          // Show a small warning on unknown options rather than erroring\n          const validationWarnings = error.details.filter(\n            err => err.type === `object.unknown`\n          )\n          const validationErrors = error.details.filter(\n            err => err.type !== `object.unknown`\n          )\n\n          // If rootDir and plugin.parentDir are the same, i.e. if this is a plugin a user configured in their gatsby-config.js (and not a sub-theme that added it), this will be \"\"\n          // Otherwise, this will contain (and show) the relative path\n          const configDir =\n            (plugin.parentDir &&\n              rootDir &&\n              path.relative(rootDir, plugin.parentDir)) ||\n            null\n          if (validationErrors.length > 0) {\n            reporter.error({\n              id: `11331`,\n              context: {\n                configDir,\n                validationErrors,\n                pluginName: plugin.resolve,\n              },\n            })\n            errors++\n          }\n\n          if (validationWarnings.length > 0) {\n            reporter.warn(\n              stripIndent(`\n                Warning: there are unknown plugin options for \"${\n                  plugin.resolve\n                }\"${\n                configDir ? `, configured by ${configDir}` : ``\n              }: ${validationWarnings\n                .map(error => error.path.join(`.`))\n                .join(`, `)}\n                Please open an issue at ghub.io/${\n                  plugin.resolve\n                } if you believe this option is valid.\n              `)\n            )\n            trackCli(`UNKNOWN_PLUGIN_OPTION`, {\n              name: plugin.resolve,\n              valueString: validationWarnings\n                .map(error => error.path.join(`.`))\n                .join(`, `),\n            })\n            // We do not increment errors++ here as we do not want to process.exit if there are only warnings\n          }\n\n          return plugin\n        }\n\n        throw error\n      }\n\n      return plugin\n    })\n  )\n  return { errors, plugins: newPlugins }\n}\n\nexport async function validateConfigPluginsOptions(\n  config: ISiteConfig = {},\n  rootDir: string | null\n): Promise<void> {\n  if (!config.plugins) return\n\n  const { errors, plugins } = await validatePluginsOptions(\n    config.plugins,\n    rootDir\n  )\n\n  config.plugins = plugins\n\n  if (errors > 0) {\n    process.exit(1)\n  }\n}\n\n/**\n * Identify which APIs each plugin exports\n */\nexport function collatePluginAPIs({\n  currentAPIs,\n  flattenedPlugins,\n}: {\n  currentAPIs: ICurrentAPIs\n  flattenedPlugins: Array<IPluginInfo & Partial<IFlattenedPlugin>>\n}): { flattenedPlugins: Array<IFlattenedPlugin>; badExports: IEntryMap } {\n  // Get a list of bad exports\n  const badExports: IEntryMap = {\n    node: [],\n    browser: [],\n    ssr: [],\n  }\n\n  flattenedPlugins.forEach(plugin => {\n    plugin.nodeAPIs = []\n    plugin.browserAPIs = []\n    plugin.ssrAPIs = []\n\n    // Discover which APIs this plugin implements and store an array against\n    // the plugin node itself *and* in an API to plugins map for faster lookups\n    // later.\n    const pluginNodeExports = resolveModuleExports(\n      `${plugin.resolve}/gatsby-node`,\n      {\n        mode: `require`,\n      }\n    )\n    const pluginBrowserExports = resolveModuleExports(\n      `${plugin.resolve}/gatsby-browser`\n    )\n    const pluginSSRExports = resolveModuleExports(\n      `${plugin.resolve}/gatsby-ssr`\n    )\n\n    if (pluginNodeExports.length > 0) {\n      plugin.nodeAPIs = _.intersection(pluginNodeExports, currentAPIs.node)\n      badExports.node = badExports.node.concat(\n        getBadExports(plugin, pluginNodeExports, currentAPIs.node)\n      ) // Collate any bad exports\n    }\n\n    if (pluginBrowserExports.length > 0) {\n      plugin.browserAPIs = _.intersection(\n        pluginBrowserExports,\n        currentAPIs.browser\n      )\n      badExports.browser = badExports.browser.concat(\n        getBadExports(plugin, pluginBrowserExports, currentAPIs.browser)\n      ) // Collate any bad exports\n    }\n\n    if (pluginSSRExports.length > 0) {\n      plugin.ssrAPIs = _.intersection(pluginSSRExports, currentAPIs.ssr)\n      badExports.ssr = badExports.ssr.concat(\n        getBadExports(plugin, pluginSSRExports, currentAPIs.ssr)\n      ) // Collate any bad exports\n    }\n  })\n\n  return {\n    flattenedPlugins: flattenedPlugins as Array<IFlattenedPlugin>,\n    badExports,\n  }\n}\n\nexport const handleMultipleReplaceRenderers = ({\n  flattenedPlugins,\n}: {\n  flattenedPlugins: Array<IFlattenedPlugin>\n}): Array<IFlattenedPlugin> => {\n  // multiple replaceRenderers may cause problems at build time\n  const rendererPlugins = flattenedPlugins\n    .filter(plugin => plugin.ssrAPIs.includes(`replaceRenderer`))\n    .map(plugin => plugin.name)\n  if (rendererPlugins.length > 1) {\n    if (rendererPlugins.includes(`default-site-plugin`)) {\n      reporter.warn(`replaceRenderer API found in these plugins:`)\n      reporter.warn(rendererPlugins.join(`, `))\n      reporter.warn(\n        `This might be an error, see: https://www.gatsbyjs.org/docs/debugging-replace-renderer-api/`\n      )\n    } else {\n      console.log(``)\n      reporter.error(\n        `Gatsby's replaceRenderer API is implemented by multiple plugins:`\n      )\n      reporter.error(rendererPlugins.join(`, `))\n      reporter.error(`This will break your build`)\n      reporter.error(\n        `See: https://www.gatsbyjs.org/docs/debugging-replace-renderer-api/`\n      )\n      if (process.env.NODE_ENV === `production`) process.exit(1)\n    }\n\n    // Now update plugin list so only final replaceRenderer will run\n    const ignorable = rendererPlugins.slice(0, -1)\n\n    // For each plugin in ignorable, set a skipSSR flag to true\n    // This prevents apiRunnerSSR() from attempting to run it later\n    const messages: Array<string> = []\n    flattenedPlugins.forEach((fp, i) => {\n      if (ignorable.includes(fp.name)) {\n        messages.push(\n          `Duplicate replaceRenderer found, skipping gatsby-ssr.js for plugin: ${fp.name}`\n        )\n        flattenedPlugins[i].skipSSR = true\n      }\n    })\n    if (messages.length > 0) {\n      console.log(``)\n      messages.forEach(m => reporter.warn(m))\n      console.log(``)\n    }\n  }\n\n  return flattenedPlugins\n}\n\nexport function warnOnIncompatiblePeerDependency(\n  name: string,\n  packageJSON: PackageJson\n): void {\n  // Note: In the future the peer dependency should be enforced for all plugins.\n  const gatsbyPeerDependency = _.get(packageJSON, `peerDependencies.gatsby`)\n  if (\n    gatsbyPeerDependency &&\n    !semver.satisfies(gatsbyVersion, gatsbyPeerDependency, {\n      includePrerelease: true,\n    })\n  ) {\n    reporter.warn(\n      `Plugin ${name} is not compatible with your gatsby version ${gatsbyVersion} - It requires gatsby@${gatsbyPeerDependency}`\n    )\n  }\n}\n"],"file":"validate.js"}